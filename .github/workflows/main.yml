name: Regenerate Mermaid Diagrams (SVG + PNG)

on:
  push:
    branches:
      - main
    paths:
      - 'diagrams/**/*.mmd'
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  update-diagrams:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Show runner info
        run: |
          echo "Running on $(uname -a)"
          echo "Node version:"
          node --version || true

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'

      - name: Install Mermaid CLI
        run: |
          npm install -g @mermaid-js/mermaid-cli
          mmdc -h || true

      

      - name: Generate SVG and PNG from Mermaid files (no-sandbox)
        run: |
          set -e
          mkdir -p diagrams
          shopt -s nullglob
          for file in diagrams/*.mmd; do
            base="${file%.mmd}"
            svg="${base}.svg"
            png="${base}.png"
            echo "Rendering $file -> $svg and $png"
            # Render SVG
            mmdc -p ./puppeteer-config.json -i "$file" -o "$svg" || { echo "::error::mmdc failed (svg) for $file"; exit 1; }
            # Render PNG
            mmdc -p ./puppeteer-config.json -i "$file" -o "$png" || { echo "::error::mmdc failed (png) for $file"; exit 1; }
          done
        shell: bash

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Python deps
        run: pip install pyyaml

      - name: Run index update script
        run: |
          python scripts/update_index.py

      - name: Show resulting index.yml and diagrams
        run: |
          echo "---- index.yml ----"
          sed -n '1,200p' index.yml || true
          echo "---- diagrams listing ----"
          ls -la diagrams || true

      - name: Commit updated diagrams and index
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: "CI: update Mermaid SVG/PNG and index"
          file_pattern: |
            diagrams/*
            index.yml
